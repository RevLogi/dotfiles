# ╭──────────────────────────────────────────────────────────╮
# │                         Plugins                          │
# ╰──────────────────────────────────────────────────────────╯

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'christoomey/vim-tmux-navigator'
set -g @plugin 'tmux-plugins/tmux-cpu'

run '~/.tmux/plugins/tpm/tpm'

# ╭──────────────────────────────────────────────────────────╮
# │                         Options                          │
# ╰──────────────────────────────────────────────────────────╯

# Terminal
set-option -sa terminal-overrides ",xterm*:Tc"
set-option -sa terminal-features ',xterm-kitty:RGB'

# Base options
set -g base-index 1
set -g pane-base-index 1
set -g renumber-windows on
set -g history-limit 50000
set -g mouse on
set -g cursor-style block
set -g allow-rename on
set -sg escape-time 0
set -sg repeat-time 500

# Key bindings
set-window-option -g mode-keys vi

# yazi
set -g allow-passthrough on
set -ga update-environment TERM
set -ga update-environment TERM_PROGRAM

# Prefix
unbind C-b
set -g prefix C-f
bind C-f send-prefix

# ╭──────────────────────────────────────────────────────────╮
# │                         Theme                            │
# ╰──────────────────────────────────────────────────────────╯

set -g status-position bottom
set -g status-justify left
set -g status-bg default
set -g status-fg '#cdd6f4'
set -g status-interval 5
set -g status-left-length 100
set -g status-right-length 100

# CPU Colors
set -g @cpu_high_fg_color "#[fg=#f38ba8]"
set -g @cpu_low_fg_color "#[fg=#a6e3a1]"
set -g @cpu_medium_fg_color "#[fg=#f9e2af]"
set -g @cpu_temp_high_fg_color "#[fg=#f38ba8]"
set -g @cpu_temp_low_fg_color "#[fg=#a6e3a1]"
set -g @cpu_temp_medium_fg_color "#[fg=#f9e2af]"

# Pane borders
set -g pane-border-style 'fg=#45475a'
set -g pane-active-border-style 'fg=#f9e2af'

# Window status
set -g window-status-style 'fg=#585b70'
set -g window-status-current-style 'fg=#cba6f7,bold'

set -g window-status-format "#I:#W"
set -g window-status-current-format "#I:#W"

# Status left - session name and path
set -g status-left "#[fg=black]  #S#[fg=magenta] #[fg=colour6]#(echo '#{pane_current_path}' | sed 's|^/Users/liuguangxi|~|' | awk -F/ '{n=NF; if (n>3) print \"..\"/$(n-2)\"/\"$(n-1)\"/\"; else print $0}') "

# Status right - cpu, ram, temp, hostname
set -g status-right "#[fg=#5c5f77,bg=default]#[fg=#40a02b]󰻠 #(/Users/liuguangxi/.tmux/plugins/tmux-cpu/scripts/cpu_percentage.sh) #[fg=#5c5f77]#[fg=colour8,bg=default] #[fg=colour179]󰍛 #(/Users/liuguangxi/.tmux/plugins/tmux-cpu/scripts/ram_percentage.sh) #[fg=colour8]#[fg=colour8,bg=default] #[fg=colour97] #(smctemp -c | awk '{print }') #[fg=colour8]#[fg=colour12,bg=default] #[fg=colour24]  MacBook-Air #[fg=colour12]"

# Copy mode styles
set -g copy-mode-match-style 'fg=#1e1e2e,bg=#cdd6f4'
set -g copy-mode-current-match-style 'fg=#1e1e2e,bg=#d20f39'

# ╭──────────────────────────────────────────────────────────╮
# │                       Keybindings                        │
# ╰──────────────────────────────────────────────────────────╯

# Vim-style pane navigation
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Open panes in current directory
bind '"' split-window -v -c "#{pane_current_path}"
bind % split-window -h -c "#{pane_current_path}"

# Open new window in current directory
bind c new-window -c ~

# Clear scrollback buffer
bind K send-keys "clear"\; send-keys "Enter"\; clear-history

# Reload tmux.conf
bind r source-file ~/.tmux.conf \; display-message "~/.tmux.conf reloaded."

# Window/session tree
bind s choose-tree -swZ
bind w choose-tree -wZ

# Visual mode
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind -T copy-mode-vi y send-keys -X copy-selection-and-cancel
bind -T copy-mode-vi Y send -X copy-end-of-line

# Resize panes with Shift
bind -n S-Up    resize-pane -U 5
bind -n S-Down  resize-pane -D 5
bind -n S-Left  resize-pane -L 5
bind -n S-Right resize-pane -R 5

# Move windows
bind -n M-S-Left swap-window -t -1\; select-window -t -1
bind -n M-S-Right swap-window -t +1\; select-window -t +1

# Smart split
bind i run-shell " \
if [ $(( \$(tmux display -p '8*#{pane_width}-20*#{pane_height}') )) -lt 0 ]; then \
  tmux splitw -v -c '#{pane_current_path}'; \
else \
  tmux splitw -h -c '#{pane_current_path}'; \
fi"

# Go to last prompt
bind b copy-mode\;\
       send-keys -X start-of-line\;\
       send-keys -X search-backward ""

bind F copy-mode\;\
       send-keys -X start-of-line\;\
       send-keys -X search-backward "FCN="

# Run cpu status
run-shell ~/.tmux/plugins/tmux-cpu/cpu.tmux
